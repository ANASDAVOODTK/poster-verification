<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poster Validator</title>
    <link rel="stylesheet" href="style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Sans+Arabic:wght@400;500;600&display=swap"
        rel="stylesheet">
</head>

<body>
    <header class="topbar">
        <h1>üó≥Ô∏è Election Poster Validator</h1>
        <span class="badge">Oman Municipal Council</span>
    </header>

    <main class="container">
        <!-- Upload Section -->
        <section id="upload-section" class="upload-section">
            <form id="form" class="upload-card">
                <input type="file" id="file" accept="image/*" required>
                <div id="placeholder" class="placeholder">
                    <div class="upload-icon">üì§</div>
                    <p>Drop your campaign poster here</p>
                    <span>or click to browse</span>
                </div>
                <img id="preview" class="preview hidden">
                <button type="submit" id="btn">Validate Poster ‚Üí</button>
            </form>
        </section>

        <!-- Loading -->
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>Analyzing poster with AI vision...</p>
            <span>Reading text and checking compliance</span>
        </div>

        <!-- Results Section - Full Width Dashboard -->
        <section id="result" class="result-dashboard hidden"></section>
    </main>

    <script>
        const form = document.getElementById('form');
        const file = document.getElementById('file');
        const preview = document.getElementById('preview');
        const placeholder = document.getElementById('placeholder');
        const loading = document.getElementById('loading');
        const result = document.getElementById('result');
        const btn = document.getElementById('btn');
        const uploadSection = document.getElementById('upload-section');

        file.onchange = e => {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        };

        form.onsubmit = async e => {
            e.preventDefault();
            if (!file.files[0]) return;

            const formData = new FormData();
            formData.append('poster', file.files[0]);

            loading.classList.remove('hidden');
            result.classList.add('hidden');
            btn.disabled = true;

            try {
                const res = await fetch('/api/validate', { method: 'POST', body: formData });
                const data = await res.json();
                render(data, preview.src);
            } catch (err) {
                result.innerHTML = `<div class="error-card">‚ùå ${err.message}</div>`;
                result.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
                btn.disabled = false;
            }
        };

        function render(d, imageSrc) {
            const cat = d.categories || {};
            const p = cat.prohibitedContent || {};
            const c = cat.contentScope || {};
            const r = cat.requiredContent || {};
            const e = cat.languageEthics || {};

            const p_violations = (p.items || []).filter(i => i.found);
            const p_passed = (p.items || []).filter(i => !i.found);

            const c_violations = (c.items || []).filter(i => i.violated);
            const c_passed = (c.items || []).filter(i => !i.violated);

            const r_missing = (r.items || []).filter(i => !i.present);
            const r_present = (r.items || []).filter(i => i.present);

            const e_failed = (e.items || []).filter(i => !i.passed);
            const e_passed = (e.items || []).filter(i => i.passed);

            const warnings = d.warnings || [];

            uploadSection.classList.add('compact');

            result.innerHTML = `
                <div class="dashboard-grid">
                    <!-- Left Column: Image & Summary -->
                    <div class="left-column">
                        <div class="poster-preview-card">
                            <h3>Submitted Poster</h3>
                            <img src="${imageSrc}" alt="Poster preview" class="poster-image">
                        </div>
                        
                        <div class="summary-card ${d.isCompliant ? 'compliant' : 'non-compliant'}">
                            <div class="verdict">
                                <span class="verdict-icon">${d.isCompliant ? '‚úÖ' : '‚ùå'}</span>
                                <div>
                                    <h2>${d.isCompliant ? 'Compliant' : 'Non-Compliant'}</h2>
                                    <p class="summary-text">${d.summary}</p>
                                </div>
                            </div>
                            <!-- Overall core still exists -->
                            <div class="overall-score">
                                <div class="score-circle ${d.overallScore >= 80 ? 'high' : d.overallScore >= 50 ? 'medium' : 'low'}">
                                    <span class="score-value">${d.overallScore}</span>
                                    <span class="score-label">Score</span>
                                </div>
                            </div>
                        </div>

                        ${d.rejectionReason ? `
                        <div class="rejection-card">
                            <h3>‚ö†Ô∏è Reason for Rejection</h3>
                            <p>${d.rejectionReason}</p>
                        </div>
                        ` : ''}

                         ${warnings.length ? `
                        <div class="warnings-card">
                            <h3>‚ö†Ô∏è Warnings (False Positives?)</h3>
                            <ul>
                                ${warnings.map(w => `<li><strong>${w.rule}:</strong> ${w.message}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}

                        <!-- Metadata / Extracted Info -->
                        <div class="info-card">
                            <h3>üìù Extracted Info</h3>
                            <div class="info-item">
                                <span class="label">Name:</span>
                                <span class="value">${d.extractedText?.candidateName || 'Not found'}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Phone:</span>
                                <span class="value">${d.extractedText?.phoneNumber || 'None'}</span>
                            </div>
                             <div class="info-item">
                                <span class="label">Doc Type:</span>
                                <span class="value">${d.documentType?.actualType || 'Unknown'}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Detailed Reports -->
                    <div class="right-column">
                        
                        <!-- 1. Prohibited Content -->
                        <div class="report-card">
                            <h3>üö´ Prohibited Content</h3>
                            <div class="check-grid">
                                ${p_violations.length ? `
                                <div class="check-section violations">
                                    <h4>Violations Found (${p_violations.length})</h4>
                                    ${p_violations.map(i => `
                                        <div class="check-item bad">
                                            <span class="check-icon">‚ùå</span>
                                            <div class="check-content">
                                                <strong>${i.rule}</strong>
                                                <p>${i.details}</p>
                                                <div class="check-meta">
                                                     <span class="location-tag">üìç ${i.location || 'Unknown'}</span>
                                                    <span class="confidence">Confidence: ${i.confidence}%</span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                ` : ''}
                                <div class="check-section passed">
                                    <h4>Passed Checks (${p_passed.length})</h4>
                                    <div class="passed-grid">
                                        ${p_passed.map(i => `
                                            <div class="check-item good-compact">
                                                <span class="check-icon">‚úì</span>
                                                <span class="check-name">${i.rule}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. Content Scope (Updated) -->
                        <div class="report-card">
                            <h3>‚öñÔ∏è Content Scope & Powers</h3>
                             <div class="check-grid">
                                ${c_violations.length ? `
                                <div class="check-section violations">
                                    <h4>Scope Violations (${c_violations.length})</h4>
                                    ${c_violations.map(i => `
                                        <div class="check-item bad">
                                            <span class="check-icon">‚úó</span>
                                            <div class="check-content">
                                                <strong>${i.rule}</strong>
                                                 <p>${i.explanation}</p>
                                                ${i.violatingObjectives ? `<div class="quote">"${i.violatingObjectives.join('", "')}"</div>` : ''}
                                                <div class="check-meta">
                                                    <span class="confidence">Confidence: ${i.confidence}%</span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                ` : ''}
                                 <div class="check-section passed">
                                    <h4>Passed Checks (${c_passed.length})</h4>
                                     <div class="passed-grid">
                                        ${c_passed.map(i => `
                                            <div class="check-item good-compact">
                                                <span class="check-icon">‚úì</span>
                                                <span class="check-name">${i.rule}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>

                         <!-- 3. Required Content -->
                        <div class="report-card">
                            <h3>‚úÖ Required Elements</h3>
                            <div class="ethics-grid">
                                ${r_missing.map(i => `
                                    <div class="ethics-item bad">
                                        <div class="ethics-header">
                                            <span class="check-icon">‚ùå</span>
                                            <strong>${i.element} Missing</strong>
                                        </div>
                                        <p>This element is mandatory for election posters.</p>
                                    </div>
                                `).join('')}
                                ${r_present.map(i => `
                                     <div class="ethics-item good">
                                        <div class="ethics-header">
                                            <span class="check-icon">‚úì</span>
                                            <strong>${i.element} Present</strong>
                                        </div>
                                        <p>Quality: ${i.quality || 'Good'}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- 4. Language & Ethics -->
                        <div class="report-card">
                            <h3>üìú Language & Ethics</h3>
                            <div class="ethics-grid">
                                ${(e.items || []).map(i => `
                                    <div class="ethics-item ${i.passed ? 'good' : 'bad'}">
                                        <div class="ethics-header">
                                            <span class="check-icon">${i.passed ? '‚úì' : '‚ùå'}</span>
                                            <strong>${i.rule}</strong>
                                        </div>
                                        <p>${i.details || ''}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="actions">
                     <button class="reset-btn" onclick="location.reload()">‚Üê Validate Another Poster</button>
                     ${d.extractedText ? `
                     <details class="debug-details">
                        <summary>Debug: Raw Extracted Text</summary>
                        <pre>${d.extractedText.rawText}</pre>
                     </details>
                     ` : ''}
                </div>
            `;
            result.classList.remove('hidden');
        }
    </script>
</body>

</html>