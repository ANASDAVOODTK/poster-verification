<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poster Validator</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Sans+Arabic:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <header class="topbar">
        <h1>üó≥Ô∏è Election Poster Validator</h1>
        <span class="badge">Oman Municipal Council</span>
    </header>

    <main class="container">
        <!-- Upload Section -->
        <section id="upload-section" class="upload-section">
            <form id="form" class="upload-card">
                <input type="file" id="file" accept="image/*" required>
                <div id="placeholder" class="placeholder">
                    <div class="upload-icon">üì§</div>
                    <p>Drop your campaign poster here</p>
                    <span>or click to browse</span>
                </div>
                <img id="preview" class="preview hidden">
                <button type="submit" id="btn">Validate Poster ‚Üí</button>
            </form>
        </section>

        <!-- Loading -->
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>Analyzing poster with AI vision...</p>
            <span>Reading text and checking compliance</span>
        </div>

        <!-- Results Section - Full Width Dashboard -->
        <section id="result" class="result-dashboard hidden"></section>
    </main>

    <script>
        const form = document.getElementById('form');
        const file = document.getElementById('file');
        const preview = document.getElementById('preview');
        const placeholder = document.getElementById('placeholder');
        const loading = document.getElementById('loading');
        const result = document.getElementById('result');
        const btn = document.getElementById('btn');
        const uploadSection = document.getElementById('upload-section');

        file.onchange = e => {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        };

        form.onsubmit = async e => {
            e.preventDefault();
            if (!file.files[0]) return;

            const formData = new FormData();
            formData.append('poster', file.files[0]);

            loading.classList.remove('hidden');
            result.classList.add('hidden');
            btn.disabled = true;

            try {
                const res = await fetch('/api/validate', { method: 'POST', body: formData });
                const data = await res.json();
                render(data, preview.src);
            } catch (err) {
                result.innerHTML = `<div class="error-card">‚ùå ${err.message}</div>`;
                result.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
                btn.disabled = false;
            }
        };

        function render(d, imageSrc) {
            const cat = d.categories || {};
            const p = cat.prohibitedContent || {};
            const a = cat.allowedContent || {};
            const e = cat.languageEthics || {};
            
            const violations = (p.items || []).filter(i => i.found);
            const passed = (p.items || []).filter(i => !i.found);
            const unauthorized = a.unauthorizedContent || [];
            const ethicsFailed = (e.items || []).filter(i => !i.passed);
            const ethicsPassed = (e.items || []).filter(i => i.passed);

            uploadSection.classList.add('compact');

            result.innerHTML = `
                <div class="dashboard-grid">
                    <!-- Left Column: Image & Summary -->
                    <div class="left-column">
                        <div class="poster-preview-card">
                            <h3>Submitted Poster</h3>
                            <img src="${imageSrc}" alt="Poster preview" class="poster-image">
                        </div>
                        
                        <div class="summary-card ${d.isCompliant ? 'compliant' : 'non-compliant'}">
                            <div class="verdict">
                                <span class="verdict-icon">${d.isCompliant ? '‚úÖ' : '‚ùå'}</span>
                                <div>
                                    <h2>${d.isCompliant ? 'Compliant' : 'Non-Compliant'}</h2>
                                    <p class="summary-text">${d.summary}</p>
                                </div>
                            </div>
                            <div class="overall-score">
                                <div class="score-circle ${d.overallScore >= 80 ? 'high' : d.overallScore >= 50 ? 'medium' : 'low'}">
                                    <span class="score-value">${d.overallScore}</span>
                                    <span class="score-label">Score</span>
                                </div>
                            </div>
                        </div>

                        <div class="scores-card">
                            <div class="score-item ${p.status}">
                                <span class="score-name">Prohibited Content</span>
                                <span class="score-val">${p.score || 0}/100</span>
                                <div class="score-bar"><div style="width: ${p.score || 0}%"></div></div>
                            </div>
                            <div class="score-item ${a.status}">
                                <span class="score-name">Allowed Content</span>
                                <span class="score-val">${a.score || 0}/100</span>
                                <div class="score-bar"><div style="width: ${a.score || 0}%"></div></div>
                            </div>
                            <div class="score-item ${e.status}">
                                <span class="score-name">Language & Ethics</span>
                                <span class="score-val">${e.score || 0}/100</span>
                                <div class="score-bar"><div style="width: ${e.score || 0}%"></div></div>
                            </div>
                        </div>

                        ${d.recommendations?.length ? `
                        <div class="recommendations-card">
                            <h3>üí° Recommendations</h3>
                            <ul>
                                ${d.recommendations.map(r => `<li>${r}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                    </div>

                    <!-- Right Column: Detailed Reports -->
                    <div class="right-column">
                        <!-- Prohibited Content Check -->
                        <div class="report-card">
                            <h3>üö´ Prohibited Content Check</h3>
                            <div class="check-grid">
                                ${violations.length ? `
                                <div class="check-section violations">
                                    <h4>Violations Found (${violations.length})</h4>
                                    ${violations.map(i => `
                                        <div class="check-item bad">
                                            <span class="check-icon">‚ùå</span>
                                            <div class="check-content">
                                                <strong>${i.ruleName}</strong>
                                                <p>${i.details}</p>
                                                <div class="check-meta">
                                                    <span class="severity ${i.severity}">${i.severity}</span>
                                                    <span class="confidence">Confidence: ${i.confidence}%</span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                ` : ''}
                                <div class="check-section passed">
                                    <h4>Passed Checks (${passed.length})</h4>
                                    <div class="passed-grid">
                                        ${passed.map(i => `
                                            <div class="check-item good">
                                                <span class="check-icon">‚úì</span>
                                                <span class="check-name">${i.ruleName}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Detected Content -->
                        <div class="report-card">
                            <h3>üìã Detected Content</h3>
                            <div class="detected-items">
                                ${(a.detectedItems || []).map(item => `
                                    <span class="detected-tag">‚úì ${item}</span>
                                `).join('')}
                            </div>
                            ${unauthorized.length ? `
                            <div class="unauthorized-section">
                                <h4>‚ö†Ô∏è Unauthorized Content</h4>
                                ${unauthorized.map(i => `
                                    <div class="check-item bad">
                                        <span class="check-icon">‚úó</span>
                                        <div class="check-content">
                                            <strong>${i.description}</strong>
                                            <div class="check-meta">
                                                <span class="severity ${i.severity}">${i.severity}</span>
                                                <span class="confidence">Confidence: ${i.confidence}%</span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                        </div>

                        <!-- Language & Ethics -->
                        <div class="report-card">
                            <h3>üìú Language & Ethics</h3>
                            <div class="ethics-grid">
                                ${(e.items || []).map(i => `
                                    <div class="ethics-item ${i.passed ? 'good' : 'bad'}">
                                        <div class="ethics-header">
                                            <span class="check-icon">${i.passed ? '‚úì' : '‚ùå'}</span>
                                            <strong>${i.ruleName}</strong>
                                        </div>
                                        <p>${i.details}</p>
                                        <div class="check-meta">
                                            <span class="severity ${i.severity}">${i.severity}</span>
                                            <span class="confidence">Confidence: ${i.confidence}%</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <button class="reset-btn" onclick="location.reload()">‚Üê Validate Another Poster</button>
            `;
            result.classList.remove('hidden');
        }
    </script>
</body>
</html>
